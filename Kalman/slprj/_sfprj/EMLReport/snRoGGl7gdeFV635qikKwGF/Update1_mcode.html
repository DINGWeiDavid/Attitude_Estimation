<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="comment">%% EKF - Update           %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"><span class="comment">% Author: Mattia Giurato  %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="comment">% Last review: 2016/03/15 %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"><span class="keyword">function</span> [<span class="mxinfo " id="T19:U1"><span class="var type1" id="S2T19U3"><span class="message error" id="M1F1C">Pkp</span></span></span>,<span class="var type1" id="S3T17U4">qkp</span>,<span class="var type1" id="S4T1U5">omekhat</span>,<span class="var type1" id="S5T1U6">RPYkal</span>,<span class="var type1" id="S6T1U7">betakp</span>] = Update(<span class="var type1" id="S7T19U10">Pkm</span>,<span class="var type1" id="S8T17U11">qkpm</span>,<span class="var type1" id="S9T1U12">betakm</span>,<span class="var type1" id="S10T1U13">Gyro</span>,<span class="var type1" id="S11T1U14">Acc</span>,<span class="var type1" id="S12T1U15">Mag</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="mxinfo " id="T2:U12"><span class="var type1" id="S13T2U18">gx</span> = <span class="mxinfo " id="T2:U14"><span class="var type1" id="S10T1U20">Gyro</span>(<span class="mxinfo " id="T2:U16">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"><span class="mxinfo " id="T2:U17"><span class="var type1" id="S14T2U24">gy</span> = <span class="mxinfo " id="T2:U19"><span class="var type1" id="S10T1U26">Gyro</span>(<span class="mxinfo " id="T2:U21">2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"><span class="mxinfo " id="T2:U22"><span class="var type1" id="S15T2U30">gz</span> = <span class="mxinfo " id="T2:U24"><span class="var type1" id="S10T1U32">Gyro</span>(<span class="mxinfo " id="T2:U26">3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="mxinfo " id="T2:U27"><span class="var type1" id="S16T2U36">ax</span> = <span class="mxinfo " id="T2:U29"><span class="var type1" id="S11T1U38">Acc</span>(1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"><span class="mxinfo " id="T2:U31"><span class="var type1" id="S17T2U42">ay</span> = <span class="mxinfo " id="T2:U33"><span class="var type1" id="S11T1U44">Acc</span>(2)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"><span class="mxinfo " id="T2:U35"><span class="var type1" id="S18T2U48">az</span> = <span class="mxinfo " id="T2:U37"><span class="var type1" id="S11T1U50">Acc</span>(3)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"><span class="mxinfo " id="T2:U39"><span class="var type1" id="S19T2U54">mx</span> = <span class="mxinfo " id="T2:U41"><span class="var type1" id="S12T1U56">Mag</span>(1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"><span class="mxinfo " id="T2:U43"><span class="var type1" id="S20T2U60">my</span> = <span class="mxinfo " id="T2:U45"><span class="var type1" id="S12T1U62">Mag</span>(2)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line"><span class="mxinfo " id="T2:U47"><span class="var type1" id="S21T2U66">mz</span> = <span class="mxinfo " id="T2:U49"><span class="var type1" id="S12T1U68">Mag</span>(3)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"><span class="mxinfo " id="T1:U51"><span class="var type1" id="S22T1U72">Gyroscope</span> = <span class="mxinfo " id="T1:U53"><span class="mxinfo " id="T3:U54">[<span class="var type1" id="S13T2U76">gx</span> <span class="var type1" id="S14T2U77">gy</span> <span class="var type1" id="S15T2U78">gz</span>]</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line"><span class="mxinfo " id="T1:U58"><span class="var type1" id="S23T1U81">Accelerometer</span> = <span class="mxinfo " id="T1:U60"><span class="mxinfo " id="T3:U61">[<span class="var type1" id="S16T2U85">ax</span> <span class="var type1" id="S17T2U86">ay</span> <span class="var type1" id="S18T2U87">az</span>]</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line"><span class="mxinfo " id="T1:U65"><span class="var type1" id="S24T1U90">Magnetometer</span> = <span class="mxinfo " id="T1:U67"><span class="mxinfo " id="T3:U68">[<span class="var type1" id="S19T2U94">mx</span> <span class="var type1" id="S20T2U95">my</span> <span class="var type1" id="S21T2U96">mz</span>]</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"><span class="comment">% Usefull values</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="mxinfo " id="T9:U72"><span class="var type1" id="S25T9U99">sigma_acc</span> = <span class="mxinfo " id="T9:U74">diag([0.77418 0.66936 0.71485])</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"><span class="mxinfo " id="T9:U75"><span class="var type1" id="S27T9U109">sigma_mag</span> = <span class="mxinfo " id="T9:U77">300*diag([0.053667 0.034382 0.071054])</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="mxinfo " id="T9:U78"><span class="var type1" id="S28T9U121">I3</span> = <span class="mxinfo " id="T9:U80">[1 0 0; 0 1 0; 0 0 1]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="mxinfo " id="T19:U81"><span class="var type1" id="S29T19U137">I6</span> = <span class="mxinfo " id="T19:U83">[1 0 0 0 0 0; 0 1 0 0 0 0; 0 0 1 0 0 0; 0 0 0 1 0 0; 0 0 0 0 1 0; 0 0 0 0 0 1]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line"><span class="mxinfo " id="T9:U84"><span class="var type1" id="S30T9U183">O3</span> = <span class="mxinfo " id="T9:U86">[0 0 0; 0 0 0; 0 0 0]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"><span class="comment">% Normalise accelerometer measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"><span class="keyword">if</span>(<span class="mxinfo " id="T4:U87"><span class="mxinfo " id="T2:U88">norm(<span class="var type1" id="S23T1U203">Accelerometer</span>)</span> == <span class="mxinfo " id="T2:U90">0</span></span>), <span class="keyword">return</span>; <span class="keyword">end</span> <span class="comment">% handle NaN</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"><span class="mxinfo " id="T1:U91"><span class="var type1" id="S32T1U208">b_acc</span> = <span class="mxinfo " id="T1:U93"><span class="var type1" id="S23T1U210">Accelerometer</span> / <span class="mxinfo " id="T2:U95">sqrt(<span class="mxinfo " id="T2:U96"><span class="mxinfo " id="T2:U97"><span class="mxinfo " id="T2:U98"><span class="var type1" id="S16T2U216">ax</span>^2</span> + <span class="mxinfo " id="T2:U100"><span class="var type1" id="S17T2U219">ay</span>^2</span></span> + <span class="mxinfo " id="T2:U102"><span class="var type1" id="S18T2U222">az</span>^2</span></span>)</span></span></span>; <span class="comment">% normalise magnitude</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"><span class="comment">% Normalise magnetometer measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"><span class="keyword">if</span>(<span class="mxinfo " id="T4:U104"><span class="mxinfo " id="T2:U105">norm(<span class="var type1" id="S24T1U230">Magnetometer</span>)</span> == <span class="mxinfo " id="T2:U107">0</span></span>), <span class="keyword">return</span>; <span class="keyword">end</span> <span class="comment">% handle NaN</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"><span class="mxinfo " id="T1:U108"><span class="var type1" id="S34T1U235">b_mag</span> = <span class="mxinfo " id="T1:U110"><span class="var type1" id="S24T1U237">Magnetometer</span> / <span class="mxinfo " id="T2:U112">sqrt(<span class="mxinfo " id="T2:U113"><span class="mxinfo " id="T2:U114"><span class="mxinfo " id="T2:U115"><span class="var type1" id="S19T2U243">mx</span>^2</span> + <span class="mxinfo " id="T2:U117"><span class="var type1" id="S20T2U246">my</span>^2</span></span> + <span class="mxinfo " id="T2:U119"><span class="var type1" id="S21T2U249">mz</span>^2</span></span>)</span></span></span>; <span class="comment">% normalise magnitude</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"><span class="comment">%% Propagated value from previous step</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line"><span class="mxinfo " id="T22:U121"><span class="var type1" id="S35T22U253">deltaXkm</span> = <span class="mxinfo " id="T22:U123">zeros(6,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line"><span class="comment">%% Accelerometer and Magnetometer correction</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line"><span class="comment">% Compute attitude matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line"><span class="mxinfo " id="T1:U124"><span class="var type1" id="S37T1U260">ro</span> = <span class="mxinfo " id="T1:U126">[<span class="mxinfo " id="T2:U127"><span class="var type1" id="S8T17U264">qkpm</span>(1)</span> ;</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line"><span class="mxinfo " id="T1:U124"><span class="mxinfo " id="T1:U126">      <span class="mxinfo " id="T2:U129"><span class="var type1" id="S8T17U268">qkpm</span>(2)</span> ;</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line"><span class="mxinfo " id="T1:U124"><span class="mxinfo " id="T1:U126">      <span class="mxinfo " id="T2:U131"><span class="var type1" id="S8T17U272">qkpm</span>(3)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line"><span class="mxinfo " id="T2:U133"><span class="var type1" id="S38T2U276">q_4</span> = <span class="mxinfo " id="T2:U135"><span class="var type1" id="S8T17U278">qkpm</span>(4)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line"><span class="mxinfo " id="T9:U137"><span class="var type1" id="S39T9U282">rox</span> = <span class="mxinfo " id="T9:U139">[   <span class="mxinfo " id="T3:U140"><span class="mxinfo " id="T2:U141">0</span>   <span class="mxinfo " id="T2:U142">-<span class="mxinfo " id="T2:U143"><span class="var type1" id="S37T1U288">ro</span>(3)</span></span>  <span class="mxinfo " id="T2:U145"><span class="var type1" id="S37T1U291">ro</span>(2)</span></span> ;</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line"><span class="mxinfo " id="T9:U137"><span class="mxinfo " id="T9:U139">         <span class="mxinfo " id="T3:U147"><span class="mxinfo " id="T2:U148"><span class="var type1" id="S37T1U295">ro</span>(3)</span>  <span class="mxinfo " id="T2:U150">0</span>    <span class="mxinfo " id="T2:U151">-<span class="mxinfo " id="T2:U152"><span class="var type1" id="S37T1U300">ro</span>(1)</span></span></span> ;</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"><span class="mxinfo " id="T9:U137"><span class="mxinfo " id="T9:U139">        <span class="mxinfo " id="T3:U154"><span class="mxinfo " id="T2:U155">-<span class="mxinfo " id="T2:U156"><span class="var type1" id="S37T1U305">ro</span>(2)</span></span> <span class="mxinfo " id="T2:U158"><span class="var type1" id="S37T1U308">ro</span>(1)</span>   <span class="mxinfo " id="T2:U160">0</span></span>   ]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"><span class="mxinfo " id="T2:U161"><span class="var type1" id="S40T2U313">norm_ro_sq</span> = <span class="mxinfo " id="T2:U163"><span class="mxinfo " id="T2:U164"><span class="mxinfo " id="T2:U165"><span class="mxinfo " id="T2:U166"><span class="var type1" id="S37T1U318">ro</span>(1)</span>^2</span> + <span class="mxinfo " id="T2:U168"><span class="mxinfo " id="T2:U169"><span class="var type1" id="S37T1U323">ro</span>(2)</span>^2</span></span> + <span class="mxinfo " id="T2:U171"><span class="mxinfo " id="T2:U172"><span class="var type1" id="S37T1U328">ro</span>(3)</span>^2</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"><span class="mxinfo " id="T9:U174"><span class="var type1" id="S41T9U333">Aqkm</span> = <span class="mxinfo " id="T9:U176"><span class="mxinfo " id="T9:U177"><span class="mxinfo " id="T9:U178">(<span class="mxinfo " id="T2:U179"><span class="mxinfo " id="T2:U180"><span class="var type1" id="S38T2U340">q_4</span>^2</span> - <span class="var type1" id="S40T2U342">norm_ro_sq</span></span>)*<span class="mxinfo " id="T9:U183"><span class="var type1" id="S28T9U343">I3</span></span></span> + <span class="mxinfo " id="T9:U185"><span class="mxinfo " id="T2:U186">2</span>*(<span class="mxinfo " id="T9:U187"><span class="var type1" id="S37T1U348">ro</span>*<span class="mxinfo " id="T3:U189"><span class="var type1" id="S37T1U350">ro</span>'</span></span>)</span></span> - <span class="mxinfo " id="T9:U191"><span class="mxinfo " id="T2:U192"><span class="mxinfo " id="T2:U193">2</span>*<span class="var type1" id="S38T2U354">q_4</span></span>*<span class="var type1" id="S39T9U355">rox</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line"><span class="comment">% Reference direction of Earth's gravitational field</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line"><span class="mxinfo " id="T1:U196"><span class="var type1" id="S42T1U358">r_acc</span> = <span class="mxinfo " id="T1:U198">[0 ;</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line"><span class="mxinfo " id="T1:U196"><span class="mxinfo " id="T1:U198">         0 ;</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line"><span class="mxinfo " id="T1:U196"><span class="mxinfo " id="T1:U198">         1]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line"><span class="mxinfo " id="T1:U199"><span class="var type1" id="S43T1U368">Aqmr</span> = <span class="mxinfo " id="T1:U201"><span class="var type1" id="S41T9U370">Aqkm</span>*<span class="mxinfo " id="T1:U203"><span class="var type1" id="S42T1U371">r_acc</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line"><span class="mxinfo " id="T1:U205"><span class="var type1" id="S44T1U374">b</span> = <span class="var type1" id="S32T1U375">b_acc</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line"><span class="mxinfo " id="T9:U208"><span class="var type1" id="S45T9U378">R</span> = <span class="mxinfo " id="T9:U210"><span class="var type1" id="S25T9U381">sigma_acc</span>^2*<span class="var type1" id="S28T9U383">I3</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line"><span class="comment">% Sensitivity Matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line"><span class="mxinfo " id="T9:U213"><span class="var type1" id="S46T9U386">Aqmrx</span> = <span class="mxinfo " id="T9:U215">[   <span class="mxinfo " id="T3:U216"><span class="mxinfo " id="T2:U217">0</span>     <span class="mxinfo " id="T2:U218">-<span class="mxinfo " id="T2:U219"><span class="var type1" id="S43T1U392">Aqmr</span>(3)</span></span>  <span class="mxinfo " id="T2:U221"><span class="var type1" id="S43T1U395">Aqmr</span>(2)</span></span> ;</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line"><span class="mxinfo " id="T9:U213"><span class="mxinfo " id="T9:U215">          <span class="mxinfo " id="T3:U223"><span class="mxinfo " id="T2:U224"><span class="var type1" id="S43T1U399">Aqmr</span>(3)</span>    <span class="mxinfo " id="T2:U226">0</span>     <span class="mxinfo " id="T2:U227">-<span class="mxinfo " id="T2:U228"><span class="var type1" id="S43T1U404">Aqmr</span>(1)</span></span></span> ;</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line"><span class="mxinfo " id="T9:U213"><span class="mxinfo " id="T9:U215">         <span class="mxinfo " id="T3:U230"><span class="mxinfo " id="T2:U231">-<span class="mxinfo " id="T2:U232"><span class="var type1" id="S43T1U409">Aqmr</span>(2)</span></span>  <span class="mxinfo " id="T2:U234"><span class="var type1" id="S43T1U412">Aqmr</span>(1)</span>    <span class="mxinfo " id="T2:U236">0</span></span>    ]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line"><span class="mxinfo " id="T20:U237"><span class="var type1" id="S47T20U417">Hk</span> = <span class="mxinfo " id="T20:U239">[<span class="var type1" id="S46T9U420">Aqmrx</span> <span class="mxinfo " id="T9:U241"><span class="var type1" id="S30T9U421">O3</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line"><span class="comment">% Gain</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line"><span class="mxinfo " id="T21:U243"><span class="var type1" id="S48T21U424">Kk</span> = <span class="mxinfo " id="T21:U245">(<span class="mxinfo " id="T21:U246"><span class="var type1" id="S7T19U428">Pkm</span>*<span class="mxinfo " id="T21:U248"><span class="var type1" id="S47T20U430">Hk</span>'</span></span>)/(<span class="mxinfo " id="T9:U250"><span class="mxinfo " id="T9:U251"><span class="mxinfo " id="T20:U252"><span class="var type1" id="S47T20U435">Hk</span>*<span class="var type1" id="S7T19U436">Pkm</span></span>*<span class="mxinfo " id="T21:U255"><span class="var type1" id="S47T20U438">Hk</span>'</span></span> + <span class="var type1" id="S45T9U439">R</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"><span class="comment">% Update Covariance</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"><span class="mxinfo " id="T19:U258"><span class="var type1" id="S2T19U442">Pkp</span> = <span class="mxinfo " id="T19:U260"><span class="mxinfo " id="T19:U261"><span class="mxinfo " id="T19:U262">(<span class="mxinfo " id="T19:U263"><span class="var type1" id="S29T19U448">I6</span> - <span class="mxinfo " id="T19:U265"><span class="var type1" id="S48T21U450">Kk</span>*<span class="var type1" id="S47T20U451">Hk</span></span></span>)*<span class="var type1" id="S7T19U452">Pkm</span></span>*<span class="mxinfo " id="T19:U269">(<span class="mxinfo " id="T19:U270"><span class="var type1" id="S29T19U456">I6</span> - <span class="mxinfo " id="T19:U272"><span class="var type1" id="S48T21U458">Kk</span>*<span class="var type1" id="S47T20U459">Hk</span></span></span>)'</span></span> + <span class="mxinfo " id="T19:U275"><span class="mxinfo " id="T21:U276"><span class="var type1" id="S48T21U462">Kk</span>*<span class="mxinfo " id="T9:U278"><span class="var type1" id="S45T9U463">R</span></span></span>*<span class="mxinfo " id="T20:U280"><span class="var type1" id="S48T21U465">Kk</span>'</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"><span class="comment">% Update state</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line"><span class="mxinfo " id="T1:U282"><span class="var type1" id="S49T1U468">epk</span> = <span class="mxinfo " id="T1:U284"><span class="var type1" id="S44T1U470">b</span> - <span class="var type1" id="S43T1U471">Aqmr</span></span></span>; <span class="comment">%residual</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line"><span class="mxinfo " id="T1:U287"><span class="var type1" id="S50T1U474">yk</span> = <span class="mxinfo " id="T1:U289"><span class="var type1" id="S49T1U476">epk</span> - <span class="mxinfo " id="T1:U291"><span class="var type1" id="S47T20U478">Hk</span>*<span class="mxinfo " id="T22:U293"><span class="var type1" id="S35T22U479">deltaXkm</span></span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line"><span class="mxinfo " id="T22:U295"><span class="var type1" id="S51T22U482">deltaXkp</span> = (<span class="mxinfo " id="T22:U297"><span class="var type1" id="S35T22U485">deltaXkm</span> + <span class="mxinfo " id="T22:U299"><span class="var type1" id="S48T21U487">Kk</span>*<span class="var type1" id="S50T1U488">yk</span></span></span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line"><span class="mxinfo " id="T19:U302"><span class="var type1" id="S7T19U491">Pkm</span> = <span class="var type1" id="S2T19U492">Pkp</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line"><span class="mxinfo " id="T22:U305"><span class="var type1" id="S35T22U495">deltaXkm</span> = <span class="var type1" id="S51T22U496">deltaXkp</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line"><span class="comment">% Reference direction of Earth's magnetic feild</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line"><span class="mxinfo " id="T1:U308"><span class="var type1" id="S52T1U499">h</span> = <span class="mxinfo " id="T1:U310"><span class="var type1" id="S41T9U501">Aqkm</span>*<span class="var type1" id="S24T1U502">Magnetometer</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line"><span class="mxinfo " id="T2:U313"><span class="var type1" id="S53T2U505">norm_h</span> = <span class="mxinfo " id="T2:U315">sqrt(<span class="mxinfo " id="T2:U316"><span class="mxinfo " id="T2:U317"><span class="mxinfo " id="T2:U318"><span class="var type1" id="S52T1U511">h</span>(1)</span>^2</span> + <span class="mxinfo " id="T2:U320"><span class="mxinfo " id="T2:U321"><span class="var type1" id="S52T1U516">h</span>(2)</span>^2</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line"><span class="mxinfo " id="T1:U323"><span class="var type1" id="S54T1U521">r_mag</span> = <span class="mxinfo " id="T1:U325">[<span class="var type1" id="S53T2U524">norm_h</span> ;</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line"><span class="mxinfo " id="T1:U323"><span class="mxinfo " id="T1:U325">           <span class="mxinfo " id="T2:U327">0</span>    ;</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line"><span class="mxinfo " id="T1:U323"><span class="mxinfo " id="T1:U325">          <span class="mxinfo " id="T2:U328"><span class="var type1" id="S52T1U529">h</span>(3)</span> ]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line"><span class="mxinfo " id="T1:U330"><span class="var type1" id="S43T1U533">Aqmr</span> = <span class="mxinfo " id="T1:U332"><span class="var type1" id="S41T9U535">Aqkm</span>*<span class="var type1" id="S54T1U536">r_mag</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line"><span class="mxinfo " id="T1:U335"><span class="var type1" id="S44T1U539">b</span> = <span class="var type1" id="S34T1U540">b_mag</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line"><span class="mxinfo " id="T9:U338"><span class="var type1" id="S45T9U543">R</span> = <span class="mxinfo " id="T9:U340"><span class="var type1" id="S27T9U546">sigma_mag</span>^2*<span class="var type1" id="S28T9U548">I3</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line"><span class="comment">% Sensitivity Matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line"><span class="mxinfo " id="T9:U343"><span class="var type1" id="S46T9U551">Aqmrx</span> = <span class="mxinfo " id="T9:U345">[      <span class="mxinfo " id="T3:U346"><span class="mxinfo " id="T2:U347">0</span>   <span class="mxinfo " id="T2:U348">-<span class="mxinfo " id="T2:U349"><span class="var type1" id="S43T1U557">Aqmr</span>(3)</span></span>  <span class="mxinfo " id="T2:U351"><span class="var type1" id="S43T1U560">Aqmr</span>(2)</span></span> ;</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line"><span class="mxinfo " id="T9:U343"><span class="mxinfo " id="T9:U345">           <span class="mxinfo " id="T3:U353"><span class="mxinfo " id="T2:U354"><span class="var type1" id="S43T1U564">Aqmr</span>(3)</span>    <span class="mxinfo " id="T2:U356">0</span>     <span class="mxinfo " id="T2:U357">-<span class="mxinfo " id="T2:U358"><span class="var type1" id="S43T1U569">Aqmr</span>(1)</span></span></span> ;</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line"><span class="mxinfo " id="T9:U343"><span class="mxinfo " id="T9:U345">          <span class="mxinfo " id="T3:U360"><span class="mxinfo " id="T2:U361">-<span class="mxinfo " id="T2:U362"><span class="var type1" id="S43T1U574">Aqmr</span>(2)</span></span>  <span class="mxinfo " id="T2:U364"><span class="var type1" id="S43T1U577">Aqmr</span>(1)</span>    <span class="mxinfo " id="T2:U366">0</span></span>    ]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line"><span class="mxinfo " id="T20:U367"><span class="var type1" id="S47T20U582">Hk</span> = <span class="mxinfo " id="T20:U369">[<span class="var type1" id="S46T9U585">Aqmrx</span> <span class="mxinfo " id="T9:U371"><span class="var type1" id="S30T9U586">O3</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line"><span class="comment">% Gain</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line"><span class="mxinfo " id="T21:U373"><span class="var type1" id="S48T21U589">Kk</span> = <span class="mxinfo " id="T21:U375">(<span class="mxinfo " id="T21:U376"><span class="var type1" id="S7T19U593">Pkm</span>*<span class="mxinfo " id="T21:U378"><span class="var type1" id="S47T20U595">Hk</span>'</span></span>)/(<span class="mxinfo " id="T9:U380"><span class="mxinfo " id="T9:U381"><span class="mxinfo " id="T20:U382"><span class="var type1" id="S47T20U600">Hk</span>*<span class="var type1" id="S7T19U601">Pkm</span></span>*<span class="mxinfo " id="T21:U385"><span class="var type1" id="S47T20U603">Hk</span>'</span></span> + <span class="var type1" id="S45T9U604">R</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line"><span class="comment">% Update Covariance</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line"><span class="mxinfo " id="T19:U388"><span class="var type1" id="S2T19U607">Pkp</span> = <span class="mxinfo " id="T19:U390"><span class="mxinfo " id="T19:U391"><span class="mxinfo " id="T19:U392">(<span class="mxinfo " id="T19:U393"><span class="var type1" id="S29T19U613">I6</span> - <span class="mxinfo " id="T19:U395"><span class="var type1" id="S48T21U615">Kk</span>*<span class="var type1" id="S47T20U616">Hk</span></span></span>)*<span class="var type1" id="S7T19U617">Pkm</span></span>*<span class="mxinfo " id="T19:U399">(<span class="mxinfo " id="T19:U400"><span class="var type1" id="S29T19U621">I6</span> - <span class="mxinfo " id="T19:U402"><span class="var type1" id="S48T21U623">Kk</span>*<span class="var type1" id="S47T20U624">Hk</span></span></span>)'</span></span> + <span class="mxinfo " id="T19:U405"><span class="mxinfo " id="T21:U406"><span class="var type1" id="S48T21U627">Kk</span>*<span class="mxinfo " id="T9:U408"><span class="var type1" id="S45T9U628">R</span></span></span>*<span class="mxinfo " id="T20:U410"><span class="var type1" id="S48T21U630">Kk</span>'</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line"><span class="comment">% Update state</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line"><span class="mxinfo " id="T1:U412"><span class="var type1" id="S49T1U633">epk</span> = <span class="mxinfo " id="T1:U414"><span class="var type1" id="S44T1U635">b</span> - <span class="var type1" id="S43T1U636">Aqmr</span></span></span>; <span class="comment">%residual</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line"><span class="mxinfo " id="T1:U417"><span class="var type1" id="S50T1U639">yk</span> = <span class="mxinfo " id="T1:U419"><span class="var type1" id="S49T1U641">epk</span> - <span class="mxinfo " id="T1:U421"><span class="var type1" id="S47T20U643">Hk</span>*<span class="var type1" id="S35T22U644">deltaXkm</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line"><span class="mxinfo " id="T22:U424"><span class="var type1" id="S51T22U647">deltaXkp</span> = (<span class="mxinfo " id="T22:U426"><span class="var type1" id="S35T22U650">deltaXkm</span> + <span class="mxinfo " id="T22:U428"><span class="var type1" id="S48T21U652">Kk</span>*<span class="var type1" id="S50T1U653">yk</span></span></span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line"><span class="comment">% Update quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line"><span class="mxinfo " id="T1:U431"><span class="var type1" id="S55T1U656">dalphak</span> = <span class="mxinfo " id="T1:U433"><span class="var type1" id="S51T22U658">deltaXkp</span>(<span class="mxinfo " id="T25:U435">1:3</span>,<span class="mxinfo " id="T6:U436">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line"><span class="mxinfo " id="T2:U437"><span class="var type1" id="S56T2U665">norm_dalphak_sq</span> = <span class="mxinfo " id="T2:U439"><span class="mxinfo " id="T2:U440"><span class="mxinfo " id="T2:U441"><span class="mxinfo " id="T2:U442"><span class="var type1" id="S55T1U670">dalphak</span>(1)</span>^2</span> + <span class="mxinfo " id="T2:U444"><span class="mxinfo " id="T2:U445"><span class="var type1" id="S55T1U675">dalphak</span>(2)</span>^2</span></span> + <span class="mxinfo " id="T2:U447"><span class="mxinfo " id="T2:U448"><span class="var type1" id="S55T1U680">dalphak</span>(3)</span>^2</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line"><span class="mxinfo " id="T17:U450"><span class="var type1" id="S57T17U685">dq</span> = <span class="mxinfo " id="T17:U452">(<span class="mxinfo " id="T2:U453"><span class="mxinfo " id="T2:U454">1</span>/<span class="mxinfo " id="T2:U455">sqrt(<span class="mxinfo " id="T2:U456"><span class="mxinfo " id="T2:U457">4</span>+<span class="var type1" id="S56T2U694">norm_dalphak_sq</span></span>)</span></span>)*<span class="mxinfo " id="T17:U459"><span class="mxinfo " id="T26:U460">[<span class="mxinfo " id="T3:U461"><span class="var type1" id="S55T1U699">dalphak</span>'</span> <span class="mxinfo " id="T2:U463">2</span>]</span>'</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line"><span class="mxinfo " id="T17:U464"><span class="var type1" id="S3T17U703">qkp</span> = <span class="mxinfo " id="T17:U466">[<span class="mxinfo " id="T1:U467"><span class="mxinfo " id="T1:U468"><span class="mxinfo " id="T1:U469"><span class="mxinfo " id="T2:U470"><span class="var type1" id="S57T17U710">dq</span>(4)</span>*<span class="var type1" id="S37T1U712">ro</span></span> + <span class="mxinfo " id="T1:U473"><span class="var type1" id="S38T2U714">q_4</span>*<span class="mxinfo " id="T1:U475"><span class="var type1" id="S57T17U716">dq</span>(<span class="mxinfo " id="T25:U477">1:3</span>,<span class="mxinfo " id="T6:U478">1</span>)</span></span></span>-<span class="mxinfo " id="T1:U479">cross(<span class="mxinfo " id="T1:U480"><span class="var type1" id="S57T17U724">dq</span>(<span class="mxinfo " id="T25:U482">1:3</span>,<span class="mxinfo " id="T6:U483">1</span>)</span>,<span class="var type1" id="S37T1U729">ro</span>)</span></span> ;</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line"><span class="mxinfo " id="T17:U464"><span class="mxinfo " id="T17:U466">               <span class="mxinfo " id="T2:U485"><span class="mxinfo " id="T2:U486"><span class="mxinfo " id="T2:U487"><span class="var type1" id="S57T17U734">dq</span>(4)</span>*<span class="var type1" id="S38T2U736">q_4</span></span> - <span class="mxinfo " id="T2:U490">dot(<span class="mxinfo " id="T1:U491"><span class="var type1" id="S57T17U740">dq</span>(<span class="mxinfo " id="T25:U493">1:3</span>,<span class="mxinfo " id="T6:U494">1</span>)</span>,<span class="var type1" id="S37T1U745">ro</span>)</span></span>       ]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line"><span class="comment">% Update biases</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line"><span class="mxinfo " id="T1:U496"><span class="var type1" id="S60T1U748">deltaBeta</span> = <span class="mxinfo " id="T1:U498"><span class="var type1" id="S51T22U750">deltaXkp</span>(<span class="mxinfo " id="T3:U500"><span class="mxinfo " id="T2:U501">4</span>:<span class="mxinfo " id="T2:U502">6</span></span>,<span class="mxinfo " id="T2:U503">1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line"><span class="mxinfo " id="T1:U504"><span class="var type1" id="S6T1U757">betakp</span> = <span class="mxinfo " id="T1:U506"><span class="var type1" id="S9T1U759">betakm</span> + <span class="var type1" id="S60T1U760">deltaBeta</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line">  </span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line"><span class="comment">%% Depolarize gyroscope measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line"><span class="mxinfo " id="T1:U509"><span class="var type1" id="S4T1U763">omekhat</span> = <span class="mxinfo " id="T1:U511"><span class="var type1" id="S22T1U765">Gyroscope</span> - <span class="var type1" id="S6T1U766">betakp</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line"><span class="comment">%% Convert Quaternion into RPY</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line"><span class="mxinfo " id="T2:U514"><span class="var type1" id="S61T2U769">a1</span> = <span class="mxinfo " id="T2:U516"><span class="mxinfo " id="T2:U517">2</span>.*(<span class="mxinfo " id="T2:U518"><span class="mxinfo " id="T2:U519"><span class="mxinfo " id="T2:U520"><span class="var type1" id="S3T17U776">qkp</span>(1)</span>.*<span class="mxinfo " id="T2:U522"><span class="var type1" id="S3T17U779">qkp</span>(<span class="mxinfo " id="T2:U524">2</span>)</span></span> + <span class="mxinfo " id="T2:U525"><span class="mxinfo " id="T2:U526"><span class="var type1" id="S3T17U783">qkp</span>(<span class="mxinfo " id="T2:U528">4</span>)</span>.*<span class="mxinfo " id="T2:U529"><span class="var type1" id="S3T17U786">qkp</span>(<span class="mxinfo " id="T2:U531">3</span>)</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line"><span class="mxinfo " id="T2:U532"><span class="var type1" id="S62T2U790">a2</span> = <span class="mxinfo " id="T2:U534"><span class="mxinfo " id="T2:U535"><span class="mxinfo " id="T2:U536"><span class="mxinfo " id="T2:U537"><span class="mxinfo " id="T2:U538"><span class="var type1" id="S3T17U796">qkp</span>(4)</span>.^2</span> + <span class="mxinfo " id="T2:U540"><span class="mxinfo " id="T2:U541"><span class="var type1" id="S3T17U801">qkp</span>(1)</span>.^2</span></span> - <span class="mxinfo " id="T2:U543"><span class="mxinfo " id="T2:U544"><span class="var type1" id="S3T17U806">qkp</span>(2)</span>.^2</span></span> - <span class="mxinfo " id="T2:U546"><span class="mxinfo " id="T2:U547"><span class="var type1" id="S3T17U811">qkp</span>(3)</span>.^2</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line"><span class="mxinfo " id="T2:U549"><span class="var type1" id="S44T2U816">b</span> = <span class="mxinfo " id="T2:U551"><span class="mxinfo " id="T2:U552">-<span class="mxinfo " id="T2:U553">2</span></span>.*(<span class="mxinfo " id="T2:U554"><span class="mxinfo " id="T2:U555"><span class="mxinfo " id="T2:U556"><span class="var type1" id="S3T17U824">qkp</span>(1)</span>.*<span class="mxinfo " id="T2:U558"><span class="var type1" id="S3T17U827">qkp</span>(<span class="mxinfo " id="T2:U560">3</span>)</span></span> - <span class="mxinfo " id="T2:U561"><span class="mxinfo " id="T2:U562"><span class="var type1" id="S3T17U831">qkp</span>(<span class="mxinfo " id="T2:U564">4</span>)</span>.*<span class="mxinfo " id="T2:U565"><span class="var type1" id="S3T17U834">qkp</span>(<span class="mxinfo " id="T2:U567">2</span>)</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line"><span class="mxinfo " id="T2:U568"><span class="var type1" id="S63T2U838">c1</span> = <span class="mxinfo " id="T2:U570"><span class="mxinfo " id="T2:U571">2</span>.*(<span class="mxinfo " id="T2:U572"><span class="mxinfo " id="T2:U573"><span class="mxinfo " id="T2:U574"><span class="var type1" id="S3T17U845">qkp</span>(2)</span>.*<span class="mxinfo " id="T2:U576"><span class="var type1" id="S3T17U848">qkp</span>(<span class="mxinfo " id="T2:U578">3</span>)</span></span> + <span class="mxinfo " id="T2:U579"><span class="mxinfo " id="T2:U580"><span class="var type1" id="S3T17U852">qkp</span>(<span class="mxinfo " id="T2:U582">4</span>)</span>.*<span class="mxinfo " id="T2:U583"><span class="var type1" id="S3T17U855">qkp</span>(<span class="mxinfo " id="T2:U585">1</span>)</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line"><span class="mxinfo " id="T2:U586"><span class="var type1" id="S64T2U859">c2</span> = <span class="mxinfo " id="T2:U588"><span class="mxinfo " id="T2:U589"><span class="mxinfo " id="T2:U590"><span class="mxinfo " id="T2:U591"><span class="mxinfo " id="T2:U592"><span class="var type1" id="S3T17U865">qkp</span>(4)</span>.^2</span> - <span class="mxinfo " id="T2:U594"><span class="mxinfo " id="T2:U595"><span class="var type1" id="S3T17U870">qkp</span>(1)</span>.^2</span></span> - <span class="mxinfo " id="T2:U597"><span class="mxinfo " id="T2:U598"><span class="var type1" id="S3T17U875">qkp</span>(2)</span>.^2</span></span> + <span class="mxinfo " id="T2:U600"><span class="mxinfo " id="T2:U601"><span class="var type1" id="S3T17U880">qkp</span>(3)</span>.^2</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line"><span class="mxinfo " id="T2:U603"><span class="var type1" id="S65T2U885">Yy</span> = <span class="mxinfo " id="T2:U605">atan2(<span class="var type1" id="S61T2U888">a1</span>, <span class="var type1" id="S62T2U889">a2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line"><span class="mxinfo " id="T2:U608"><span class="var type1" id="S67T2U892">Pp</span> = <span class="mxinfo " id="T2:U610">asin(<span class="var type1" id="S44T2U895">b</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line"><span class="mxinfo " id="T2:U612"><span class="var type1" id="S69T2U898">Rr</span> = <span class="mxinfo " id="T2:U614">atan2(<span class="var type1" id="S63T2U901">c1</span>, <span class="var type1" id="S64T2U902">c2</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line"><span class="mxinfo " id="T1:U617"><span class="var type1" id="S5T1U905">RPYkal</span> = <span class="mxinfo " id="T1:U619"><span class="mxinfo " id="T3:U620">[<span class="var type1" id="S69T2U909">Rr</span> <span class="mxinfo " id="T2:U622">-<span class="var type1" id="S67T2U911">Pp</span></span> <span class="mxinfo " id="T2:U624">-<span class="var type1" id="S65T2U913">Yy</span></span>]</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line">    </span></span>
</pre>
